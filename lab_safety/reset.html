<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabaseUrl = "https://abhpqjalptewznfnelwf.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiaHBxamFscHRld3puZm5lbHdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNDM1NzIsImV4cCI6MjA3ODgxOTU3Mn0.Zf4IkSwD1os1xJ2bs7PUOvFaih8Rz0hI_jMghh731Gw";
  
  // Initialize Supabase with specific settings to ensure it detects the URL
  const supabase = createClient(supabaseUrl, supabaseKey, {
    auth: {
      detectSessionInUrl: true,
      flowType: 'pkce'
    }
  });

  const updateBtn = document.getElementById('updateBtn');
  const newPasswordInput = document.getElementById('newPassword');
  const messageDiv = document.getElementById('message');

  // 1. Initial State: Locked
  updateBtn.disabled = true;
  newPasswordInput.disabled = true;

  // 2. Check the URL immediately
  // A valid reset link MUST have either a #hash (implicit) or ?code (PKCE)
  const hasHash = window.location.hash && window.location.hash.includes('type=recovery');
  const hasCode = window.location.search && window.location.search.includes('code=');
  const hasError = window.location.hash && window.location.hash.includes('error_description');

  if (hasError) {
      // Supabase sent us back with an explicit error (e.g. link expired)
      const params = new URLSearchParams(window.location.hash.substring(1)); // remove #
      messageDiv.textContent = decodeURIComponent(params.get('error_description')).replace(/\+/g, ' ');
      messageDiv.className = "error";
  } 
  else if (!hasHash && !hasCode) {
      // No security codes found in URL
      // Check if user is ALREADY logged in from a previous session
      supabase.auth.getSession().then(({ data: { session } }) => {
          if (session) {
              enableForm();
          } else {
              messageDiv.textContent = "Invalid or expired link. Please request a new password reset.";
              messageDiv.className = "error";
          }
      });
  } 
  else {
      // Valid codes found. Wait indefinitely for Supabase to process them.
      messageDiv.textContent = "Verifying security token... please wait...";
  }

  // 3. Listen for the Auth Event
  supabase.auth.onAuthStateChange(async (event, session) => {
    console.log("Auth Event:", event);
    
    if (event === "SIGNED_IN" || event === "PASSWORD_RECOVERY" || session) {
      enableForm();
    }
  });

  function enableForm() {
      messageDiv.textContent = ""; 
      updateBtn.disabled = false;
      newPasswordInput.disabled = false;
      newPasswordInput.focus();
  }

  // 4. Update Button Logic
  updateBtn.onclick = async () => {
    const newPassword = newPasswordInput.value;
    
    if (!newPassword || newPassword.length < 6) {
      messageDiv.textContent = "Password must be at least 6 characters.";
      messageDiv.className = "error";
      return;
    }

    updateBtn.disabled = true;
    updateBtn.textContent = "Updating...";

    const { data, error } = await supabase.auth.updateUser({ 
      password: newPassword 
    });

    if (error) {
      messageDiv.textContent = "Error: " + error.message;
      messageDiv.className = "error";
      updateBtn.disabled = false;
      updateBtn.textContent = "Update Password";
    } else {
      messageDiv.textContent = "Password updated successfully! Redirecting...";
      messageDiv.className = "success";
      
      // Redirect back to main page after 2 seconds
      setTimeout(() => {
        window.location.href = "https://cody-the-only-one.github.io/random_pchem_stuff/lab_safety/apsu_lab_safety_form.html"; 
      }, 2000);
    }
  };
</script>

</body>
</html>