<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Use the SAME credentials as your main file
  const supabaseUrl = "https://abhpqjalptewznfnelwf.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiaHBxamFscHRld3puZm5lbHdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNDM1NzIsImV4cCI6MjA3ODgxOTU3Mn0.Zf4IkSwD1os1xJ2bs7PUOvFaih8Rz0hI_jMghh731Gw";
  const supabase = createClient(supabaseUrl, supabaseKey);

  const updateBtn = document.getElementById('updateBtn');
  const newPasswordInput = document.getElementById('newPassword');
  const messageDiv = document.getElementById('message');

  // 1. Set Initial State to "Loading"
  messageDiv.textContent = "Verifying link...";
  updateBtn.disabled = true;
  newPasswordInput.disabled = true;

  // 2. Listen for the login event
  supabase.auth.onAuthStateChange(async (event, session) => {
    console.log("Auth Event:", event); // Debugging aid

    // If Supabase successfully processes the link, it fires PASSWORD_RECOVERY or SIGNED_IN
    if (event === "PASSWORD_RECOVERY" || event === "SIGNED_IN" || session) {
      messageDiv.textContent = ""; // Clear the loading message
      updateBtn.disabled = false;
      newPasswordInput.disabled = false;
      newPasswordInput.focus();
    } 
  });

  // 3. Fallback Check
  // Sometimes the event fires before the script runs. We double check after 1 second.
  // Only show the error if we are STILL not logged in after waiting.
  setTimeout(async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
       // Check if there are actually URL parameters (hash or search)
       // If there are no parameters, it's definitely an error/direct visit.
       const hasUrlParams = window.location.hash || window.location.search;
       
       if (!hasUrlParams) {
          messageDiv.textContent = "No active reset session found. Please request a new link.";
          messageDiv.className = "error";
       } else {
          // If params exist but session is null, the link might be expired or invalid
          // But we give it another moment just in case network is slow
          setTimeout(async () => {
             const { data: { session: retrySession } } = await supabase.auth.getSession();
             if(!retrySession) {
                messageDiv.textContent = "This link appears to be invalid or expired.";
                messageDiv.className = "error";
             }
          }, 2000);
       }
    }
  }, 1000);

  updateBtn.onclick = async () => {
    const newPassword = newPasswordInput.value;
    
    if (!newPassword || newPassword.length < 6) {
      messageDiv.textContent = "Password must be at least 6 characters.";
      messageDiv.className = "error";
      return;
    }

    updateBtn.disabled = true;
    updateBtn.textContent = "Updating...";

    const { data, error } = await supabase.auth.updateUser({ 
      password: newPassword 
    });

    if (error) {
      messageDiv.textContent = "Error: " + error.message;
      messageDiv.className = "error";
      updateBtn.disabled = false;
      updateBtn.textContent = "Update Password";
    } else {
      messageDiv.textContent = "Password updated successfully! Redirecting...";
      messageDiv.className = "success";
      
      // Redirect back to main page after 2 seconds
      setTimeout(() => {
        window.location.href = "https://cody-the-only-one.github.io/random_pchem_stuff/lab_safety/apsu_lab_safety_form.html"; 
      }, 2000);
    }
  };
</script>

</body>
</html>