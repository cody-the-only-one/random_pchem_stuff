<!DOCTYPE html>
<html>
<head>
    <title>Pine Hollow Incident - Interactive Timeline</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- noUiSlider CSS and JS for the range slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        .legend {
            padding: 6px 10px; font-size: 14px; background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px;
        }
        .legend h4 { margin: 0 0 5px 0; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.8; border-radius: 50%; }
        #slider-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 900px; background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000; text-align: center;
        }
        #time-slider { height: 12px; border: 1px solid #ccc; background: #f0f0f0; border-radius: 6px; }
        #current-time-label { font-weight: bold; font-size: 16px; margin-bottom: 15px; }
        #total-range-labels { display: flex; justify-content: space-between; font-size: 12px; color: #555; margin-top: 10px; }
        .noUi-connect { background: #3498db; }
        .noUi-handle { border-radius: 50%; background: #fff; border: 2px solid #3498db; box-shadow: none; }
        .noUi-handle:after, .noUi-handle:before { display: none; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="slider-container">
    <div id="current-time-label">Loading timeline...</div>
    <div id="time-slider"></div>
    <div id="total-range-labels">
        <span id="start-time-label"></span>
        <span id="end-time-label"></span>
    </div>
</div>

<script>
    // --- 1. Initialize Map ---
    const map = L.map('map').setView([34.8, -118.4], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // --- 2. Data Preparation ---
    // **DATA CORRECTION**: A 60-minute gap is now explicit for Tomás at home (01:40 to 02:40) to force path segmentation.
const pingData = [
    // Phase 1: June 10, 16:00 - Ethan and Marcus travel to and arrive at the campsite.
    // Tomás remains static at his home in Glendale.
    { name: "Ethan Morales", lat: 34.0905, lng: -118.3618, time: "2025-06-10 16:00" },
    { name: "Marcus Blake", lat: 34.0623, lng: -118.3597, time: "2025-06-10 16:00" },
    { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-10 16:00" },
    { name: "Ethan Morales", lat: 34.1365, lng: -118.3542, time: "2025-06-10 16:20" },
    { name: "Marcus Blake", lat: 34.1364, lng: -118.3540, time: "2025-06-10 16:20" },
    { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-10 16:20" },
    { name: "Ethan Morales", lat: 34.2011, lng: -118.3945, time: "2025-06-10 16:40" },
    { name: "Marcus Blake", lat: 34.2010, lng: -118.3946, time: "2025-06-10 16:40" },
    { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-10 16:40" },
    { name: "Ethan Morales", lat: 34.2658, lng: -118.4485, time: "2025-06-10 17:00" },
    { name: "Marcus Blake", lat: 34.2657, lng: -118.4484, time: "2025-06-10 17:00" },
    { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-10 17:00" },
    { name: "Ethan Morales", lat: 34.3411, lng: -118.4699, time: "2025-06-10 17:20" },
    { name: "Marcus Blake", lat: 34.3412, lng: -118.4698, time: "2025-06-10 17:20" },
    { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-10 17:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-10 17:40" },
    { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-10 17:40" },
    { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-10 17:40" },

    // Phase 2: June 10, 18:00 to June 11, 21:20 - Long period of inactivity.
    // Ethan & Marcus are static at the campsite. Tomás is static at home.
    ...Array.from({length: 82}, (_, i) => { const ts = new Date(new Date("2025-06-10 18:00").getTime() + i * 20 * 60000); const timeStr = ts.toISOString().slice(0, 16).replace('T', ' '); return [ { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: timeStr }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: timeStr }, { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: timeStr }]; }).flat(),
    
    // Phase 3: June 11, 21:40 - Tomás begins his journey to the campsite.
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-11 21:40" },
    { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-11 21:40" },
    { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-11 21:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-11 22:00" },
    { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-11 22:00" },
    { name: "Tomás Rivera", lat: 34.2283, lng: -118.3588, time: "2025-06-11 22:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-11 22:20" },
    { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-11 22:20" },
    { name: "Tomás Rivera", lat: 34.2882, lng: -118.4550, time: "2025-06-11 22:20" },

    // Phase 4: June 11, 22:40 to 23:40 - All three are together at the campsite before the incident.
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-11 22:40" },
    { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-11 22:40" },
    { name: "Tomás Rivera", lat: 34.3780, lng: -118.4350, time: "2025-06-11 22:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:00" },
    { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:00" },
    { name: "Tomás Rivera", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:20" },
    { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:20" },
    { name: "Tomás Rivera", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:40" },
    { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:40" },
    { name: "Tomás Rivera", lat: 34.3780, lng: -118.4350, time: "2025-06-11 23:40" },

    // Phase 5: June 12, 00:00 onward - Post-incident. Tomás flees, returns home, then flees north.
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 00:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 00:00" }, { name: "Tomás Rivera", lat: 34.3215, lng: -118.4599, time: "2025-06-12 00:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 00:20" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 00:20" }, { name: "Tomás Rivera", lat: 34.2750, lng: -118.4510, time: "2025-06-12 00:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 00:40" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 00:40" }, { name: "Tomás Rivera", lat: 34.2283, lng: -118.3588, time: "2025-06-12 00:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 01:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 01:00" }, { name: "Tomás Rivera", lat: 34.1755, lng: -118.2794, time: "2025-06-12 01:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 01:20" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 01:20" }, { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-12 01:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 01:40" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 01:40" }, { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-12 01:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 02:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 02:00" }, { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-12 02:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 02:20" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 02:20" }, { name: "Tomás Rivera", lat: 34.1401, lng: -118.2555, time: "2025-06-12 02:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 02:40" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 02:40" }, { name: "Tomás Rivera", lat: 34.2755, lng: -118.4515, time: "2025-06-12 02:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 03:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 03:00" }, { name: "Tomás Rivera", lat: 34.4211, lng: -118.5520, time: "2025-06-12 03:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 03:20" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 03:20" }, { name: "Tomás Rivera", lat: 34.5682, lng: -118.6381, time: "2025-06-12 03:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 03:40" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 03:40" }, { name: "Tomás Rivera", lat: 34.7085, lng: -118.7344, time: "2025-06-12 03:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 04:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 04:00" }, { name: "Tomás Rivera", lat: 34.8233, lng: -118.8625, time: "2025-06-12 04:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 04:20" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 04:20" }, { name: "Tomás Rivera", lat: 34.9511, lng: -118.9658, time: "2025-06-12 04:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 04:40" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 04:40" }, { name: "Tomás Rivera", lat: 35.0850, lng: -119.0112, time: "2025-06-12 04:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 05:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 05:00" }, { name: "Tomás Rivera", lat: 35.2285, lng: -119.0300, time: "2025-06-12 05:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 05:20" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 05:20" }, { name: "Tomás Rivera", lat: 35.3621, lng: -119.0195, time: "2025-06-12 05:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 05:40" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 05:40" }, { name: "Tomás Rivera", lat: 35.4950, lng: -119.1233, time: "2025-06-12 05:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 06:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 06:00" }, { name: "Tomás Rivera", lat: 35.6201, lng: -119.2680, time: "2025-06-12 06:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 06:20" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 06:20" }, { name: "Tomás Rivera", lat: 35.7515, lng: -119.4141, time: "2025-06-12 06:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 06:40" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 06:40" }, { name: "Tomás Rivera", lat: 35.8828, lng: -119.5598, time: "2025-06-12 06:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 07:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 07:00" }, { name: "Tomás Rivera", lat: 36.0142, lng: -119.7055, time: "2025-06-12 07:00" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 07:20" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 07:20" }, { name: "Tomás Rivera", lat: 36.1455, lng: -119.8512, time: "2025-06-12 07:20" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 07:40" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 07:40" }, { name: "Tomás Rivera", lat: 36.2768, lng: -119.9969, time: "2025-06-12 07:40" },
    { name: "Ethan Morales", lat: 34.3780, lng: -118.4350, time: "2025-06-12 08:00" }, { name: "Marcus Blake", lat: 34.3780, lng: -118.4350, time: "2025-06-12 08:00" }, { name: "Tomás Rivera", lat: 36.4081, lng: -120.1426, time: "2025-06-12 08:00" }
];

    // --- 3. Pre-process Data into Segments ---
    // This is the core of the fix. It runs ONCE to structure the data correctly.
    const subjectDetails = { "Ethan Morales": { color: 'blue' }, "Marcus Blake": { color: 'green' }, "Tomás Rivera": { color: 'red' } };
    const subjectPaths = {};
    const timeGapThreshold = 40 * 60 * 1000; // 40 minutes

    pingData.forEach(p => p.timestamp = new Date(p.time).getTime());
    pingData.sort((a, b) => a.timestamp - b.timestamp);
    const allPingsByName = { "Ethan Morales": [], "Marcus Blake": [], "Tomás Rivera": [] };
    pingData.forEach(p => allPingsByName[p.name].push(p));

    for (const name in allPingsByName) {
        subjectPaths[name] = { color: subjectDetails[name].color, segments: [] };
        const personPings = allPingsByName[name];
        if (personPings.length === 0) continue;

        let currentSegment = [personPings[0]];
        for (let i = 1; i < personPings.length; i++) {
            if (personPings[i].timestamp - personPings[i - 1].timestamp > timeGapThreshold) {
                subjectPaths[name].segments.push(currentSegment);
                currentSegment = [];
            }
            currentSegment.push(personPings[i]);
        }
        subjectPaths[name].segments.push(currentSegment);
    }
    
    // --- 4. Initialize Slider ---
    const timePoints = [...new Set(pingData.map(p => p.timestamp))].sort((a,b) => a-b);
    const slider = document.getElementById('time-slider');
    noUiSlider.create(slider, {
        start: [0, timePoints.length - 1], connect: true, step: 1,
        range: { 'min': 0, 'max': timePoints.length - 1 }
    });
    const currentTimeLabel = document.getElementById('current-time-label');
    function formatTimestamp(ms) {
        return new Date(ms).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
    }
    document.getElementById('start-time-label').innerText = formatTimestamp(timePoints[0]);
    document.getElementById('end-time-label').innerText = formatTimestamp(timePoints[timePoints.length - 1]);

    // --- 5. Map Drawing Logic ---
    const polylinesLayer = L.layerGroup().addTo(map);
    const markersLayer = L.layerGroup().addTo(map);

    function updateMap(values) {
        polylinesLayer.clearLayers();
        markersLayer.clearLayers();

        const [startIndex, endIndex] = values.map(v => Math.round(v));
        const startTime = timePoints[startIndex];
        const endTime = timePoints[endIndex];
        currentTimeLabel.innerHTML = `Displaying Range:<br>${formatTimestamp(startTime)} to ${formatTimestamp(endTime)}`;
        
        for (const name in subjectPaths) {
            const person = subjectPaths[name];
            person.segments.forEach(segment => {
                const visiblePingsInSegment = segment.filter(p => p.timestamp >= startTime && p.timestamp <= endTime);
                
                if (visiblePingsInSegment.length > 0) {
                    const latLngs = [];
                    visiblePingsInSegment.forEach(ping => {
                        latLngs.push([ping.lat, ping.lng]);
                        // Draw marker for every point
                        L.circleMarker([ping.lat, ping.lng], {
                            color: person.color, radius: 5, fillOpacity: 0.7
                        }).addTo(markersLayer)
                          .bindTooltip(`<b>${name}</b><br>${formatTimestamp(ping.timestamp)}`);
                    });

                    // Draw the polyline for this visible part of the segment
                    if (latLngs.length > 1) {
                        L.polyline(latLngs, { color: person.color, weight: 3, opacity: 0.7 }).addTo(polylinesLayer);
                    }
                }
            });
        }
    }

    // --- 6. Link Slider to Map and Perform Initial Draw ---
    slider.noUiSlider.on('update', updateMap);
    updateMap(slider.noUiSlider.get());

    // --- 7. Legend ---
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        div.innerHTML += '<h4>Subject Paths</h4>';
        for (const name in subjectDetails) {
            div.innerHTML += `<i style="background:${subjectDetails[name].color}"></i> ${name}<br>`;
        }
        return div;
    };
    legend.addTo(map);
</script>
</body>
</html>